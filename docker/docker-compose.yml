version: '3'
services:
    activemq:
        # its not supported in M1 Mac, workaround is to enable Rosetta in Docker
        # Docker settings → Features in development → check ☑ Use Rosetta for x86/amd64 emulation on Apple Silicon, and then restart Docker.
        image: 'apache/activemq-artemis:2.37.0'
        environment:
            - "ARTEMIS_USER=admin"
            - "ARTEMIS_PASSWORD=admin"
        ports:
            - "8161:8161"  # use this to access from browser
            - "61616:61616"
        networks:
            - gtapp-network
    mysql:
        image: 'mysql'
        environment:
            - "MYSQL_USER=seedappuser"
            - "MYSQL_ROOT_PASSWORD=password"
            - "MYSQL_DATABASE=seedapp"
        ports:
            - "3306:3306"
        command: mysqld --lower_case_table_names=1 --character_set_server=utf8mb4 --explicit_defaults_for_timestamp
        networks:
            - gtapp-network
    emailhog:
        image: 'richarvey/mailhog'
        ports:
            - "1025:1025"
            - "8025:8025"  # use this to access from browser
        networks:
            - gtapp-network
    zipkin:
        image: 'openzipkin/zipkin'
        ports:
            - "9411:9411"
        networks:
            - gtapp-network
    keycloak:
        image: 'quay.io/keycloak/keycloak:25.0.6'
        command: start-dev --import-realm
        environment:
            - "KEYCLOAK_DB=dev-file"
            - "KEYCLOAK_ADMIN=admin"
            - "KEYCLOAK_ADMIN_PASSWORD=admin"
            - "KEYCLOAK_FEATURES=scripts"
            - "KEYCLOAK_HTTP_PORT=8080"
            - "KEYCLOAK_HTTPS_PORT=9443"
        volumes:
            - ../main-app/main-webapp/src/main/resources/keycloak/:/opt/keycloak/data/import
        ports:
            - "8082:8080"
            - "9443:9443"
        networks:
            - gtapp-network

    content-checker-service:
        image: gtapp-content-checker-service:latest
        environment:
            - "ZIPKIN_HOST=zipkin"
            - "ACTIVEMQ_ARTEMIS_HOST=activemq"
        ports:
            - "8083:8083"
        networks:
            - gtapp-network
        depends_on:
            - zipkin
            - activemq
    email-service:
        image: gtapp-email-service:latest
        environment:
            - "MAILHOG_HOST=emailhog"
            - "ZIPKIN_HOST=zipkin"
        ports:
            - "8085:8085"
        networks:
            - gtapp-network
        depends_on:
            - emailhog
            - zipkin
    trend-service:
        image: gtapp-trend-service:latest
        environment:
            - "ZIPKIN_HOST=zipkin"
            - "ACTIVEMQ_ARTEMIS_HOST=activemq"
        ports:
            - "8084:8084"
        networks:
            - gtapp-network
        depends_on:
            - zipkin
    report-service:
        image: gtapp-report-service:latest
        environment:
            - "ZIPKIN_HOST=zipkin"
            - "MYSQL_HOST=mysql"
            - "KEYCLOAK_HOST=keycloak"
        ports:
            - "8086:8086"
        networks:
            - gtapp-network
        depends_on:
            - zipkin
            - mysql
            - keycloak
    main-webapp:
        image: gtapp-main-webapp:latest
        environment:
            - "MYSQL_HOST=mysql"
            - "ACTIVEMQ_ARTEMIS_HOST=activemq"
            - "KEYCLOAK_HOST=keycloak"
            - "KEYCLOAK_PORT=8082"
            - "EMAIL_SERVICE_HOST=email-service"
            - "REPORT_SERVICE_HOST=report-service"
            - "ZIPKIN_HOST=zipkin"
        ports:
            - "8081:8081"
        networks:
            - gtapp-network
        depends_on:
            - zipkin
            - email-service
            - mysql
            - activemq
            - keycloak
networks:
    gtapp-network:
        driver: bridge
volumes:
    db-data:
